#!/usr/bin/env python
#-*- coding:utf-8 -*-

def main():
  #解决python 2.x中中文以ascii编码的错误
  import sys
  if sys.version_info.major < 3:
    reload(sys)
    sys.setdefaultencoding('utf8')

  import optparse
  parser = optparse.OptionParser()
  parser.add_option(
    '--auth', '-a', action = 'store_true', help = '进行用户信息验证'
  )
  parser.add_option(
    '--member', '-m', action = 'store_true', help = '获取成员信息'
  )

  parser.add_option(
    '--organization', '-o', action = 'store_true', help = '获取组织信息'
  )
  options, arguments = parser.parse_args()

  if options.auth:
    return auth()

  if options.organization:
    if len(arguments) == 0:
      return printOrgList()
    elif options.member:
      return printOrgMembers(arguments[0])
    else:
      return printOrgInfo(arguments[0])

  print(parser.print_help())

def auth():
  from trello.oauth import Oauth
  oauth = Oauth(getConfigFileName())
  try:
    oauth.oauth()
  except:
    print('用户信息验证失败。')

def printOrgList():
  from trello import getOrgs
  orgs = getData(getOrgs)
  if orgs:
    for org in orgs:
      print(org['displayName'] + '（' + org['name'] + '）')

def printOrgMembers(orgName):
  from trello import getOrgMembers
  members = getData(getOrgMembers, orgName)
  if members:
    for member in members:
      print(member['fullName'] + '（' + member['username'] + '）')

def printOrgInfo(orgName):
  from trello import getOrgInfo
  orgInfo = getData(getOrgInfo, orgName)
  if orgInfo:
    print('名称：%s（%s）' % (orgInfo['displayName'], orgInfo['name']))
    print('Trello链接：%s' % orgInfo['url'])
    print('官网：%s' % orgInfo['website'])
    print('描述：%s' % orgInfo['desc'])

def getData(function, *arg):
  try:
    dataSet = function(getConfigFileName(), *arg)
    return dataSet
  except:
    from os import path
    print(
      '数据获取失败：请检查您的网络是否正常。\n' +
      '如果网络正常请执行%s auth进行用户信息验证'
      % path.abspath(__file__)
    )
    return None

def getConfigFileName():
  from os import path
  return path.abspath(__file__ + '/../../config.json')

if __name__ == '__main__':
  main()
